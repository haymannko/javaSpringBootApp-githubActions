

name: Java CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    name: Build JAR file
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build project with Maven
        run: |
          mvn clean install -DskipTests

      - name: Upload built JAR
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: target/*.jar

  deploy:
    name: Deploy to Z.com VPS
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download built JAR
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar
          path: .

      - name: Set up SSH key for Z.com VPS
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ZOOM_SSH_KEY }}" > ~/.ssh/pemkey.pem
          chmod 600 ~/.ssh/pemkey.pem
          ssh-keyscan -H ${{ secrets.ZOOM_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy and Restart Service
        run: |
          echo "🚀 Copying JAR to server..."
          scp -o StrictHostKeyChecking=no -i ~/.ssh/pemkey.pem ./target/calculator-1.0.jar ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/calculator-1.0.jar

          echo "🔁 Running remote deployment..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/pemkey.pem ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            echo "🚀 Updating server and preparing environment..."
            sudo apt update -y
            sudo apt install -y openjdk-17-jdk maven

            echo "🧹 Cleaning up and deploying new JAR..."
            sudo mkdir -p /opt/myapp
            sudo mv /tmp/calculator-1.0.jar /opt/myapp/myapp.jar
            sudo chown appuser:appuser /opt/myapp/myapp.jar
            sudo chmod 644 /opt/myapp/myapp.jar


            echo "🔄 Reloading and restarting services..."
            sudo systemctl daemon-reload
            sudo systemctl restart javasimple.service
            sudo systemctl restart javaforking.service

            echo "✅ Deployment complete. Checking status..."
            sudo systemctl status javasimple.service --no-pager
            sudo systemctl status javaforking.service --no-pager
          EOF
