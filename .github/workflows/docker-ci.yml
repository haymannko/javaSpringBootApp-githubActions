name: Java CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    name: Build JAR file
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build project with Maven
        run: |
          mvn clean install -DskipTests

      - name: Upload built JAR
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: target/*.jar

  deploy:
    name: Deploy to Z.com VPS
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download built JAR
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar
          path: .

      - name: Set up SSH key for Z.com VPS
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ZOOM_SSH_KEY }}" > ~/.ssh/pemkey.pem
          chmod 600 ~/.ssh/pemkey.pem
          ssh-keyscan -H ${{ secrets.ZOOM_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy and Restart Service
        run: |
          echo "ðŸš€ Copying JAR to server..."
          scp -o StrictHostKeyChecking=no -i ~/.ssh/pemkey.pem ./target/*.jar ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/calculator-1.0.jar


          echo "ðŸ”§ Running remote deployment..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/pemkey.pem ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e

            echo "ðŸ§° Installing dependencies..."
            sudo apt update -y
            sudo apt install -y openjdk-17-jdk

            echo "ðŸ“¦ Deploying new JAR..."
            sudo mkdir -p /opt/myapp
            sudo mv /tmp/calculator-1.0.jar /opt/myapp/myapp.jar
            sudo chmod 644 /opt/myapp/myapp.jar


            echo "ðŸ‘¤ Setting permissions..."
            if ! id "appuser" &>/dev/null; then
              sudo useradd -r -s /bin/false appuser
            fi
            sudo chown appuser:appuser /opt/myapp/myapp.jar

            echo "âš™ï¸ Creating systemd services..."

            # javasimple.service
            sudo bash -c "cat > /etc/systemd/system/javasimple.service <<EOL
[Unit]
Description=Java Simple Service
After=network.target

[Service]
User=appuser
ExecStart=/usr/bin/java -jar /opt/myapp/myapp.jar
SuccessExitStatus=143
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOL"

            # javaforking.service
            sudo bash -c "cat > /etc/systemd/system/javaforking.service <<EOL
[Unit]
Description=Java Forking Service
After=network.target


[Service]
Type=forking
User=appuser
ExecStart=/usr/bin/java -jar /opt/myapp/myapp.jar &
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOL"

            echo "ðŸ” Reloading and restarting services..."
            sudo systemctl daemon-reload
            sudo systemctl enable javasimple.service
            sudo systemctl enable javaforking.service
            sudo systemctl restart javasimple.service
            sudo systemctl restart javaforking.service


            echo "âœ… Deployment complete!"
            sudo systemctl status javasimple.service --no-pager
            sudo systemctl status javaforking.service --no-pager
          EOF
